import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from pathlib import Path

# ----------------------------
# YOUR DATA DIRECTORY
# ----------------------------
DATA_DIR = Path(r"C:\Users\QiuDi\OneDrive\Documents\SSB MRes\S5")


def load_plate_deltaA(excel_path, sheet_name="End point"):
    """
    Load a BMG Excel export like pb1a.xlsx and return ΔA = A975 - A900
    as an 8x12 DataFrame (rows A–H, cols 1–12).
    """
    df = pd.read_excel(excel_path, sheet_name=sheet_name, header=None)

    # Block containing "Blank corrected based on Raw Data (900 1)"
    a900_block = df.iloc[14:22, 1:13].astype(float)

    # Block containing "Blank corrected based on Raw Data (975 2)"
    a975_block = df.iloc[25:33, 1:13].astype(float)

    # Add correct row/column labels
    rows = list("ABCDEFGH")
    cols = list(range(1, 13))

    a900_block.index = rows
    a900_block.columns = cols
    a975_block.index = rows
    a975_block.columns = cols

    return a975_block - a900_block

def plot_heatmap_z(deltaA, excel_path):
    """
    Plot a heatmap of z-scores of ΔA for an 8×12 plate,
    dropping blank Column 12 automatically.
    """
    # Drop any column that is all-NaN (like column 12)
    deltaA = deltaA.dropna(axis=1, how='all')

    mean = np.nanmean(deltaA.values)
    std = np.nanstd(deltaA.values)
    z = (deltaA - mean) / std

    fig, ax = plt.subplots(figsize=(8, 5))
    im = ax.imshow(z.values, aspect="auto")

    # X labels now match the actual remaining columns
    cols = deltaA.columns
    ax.set_xticks(range(len(cols)))
    ax.set_xticklabels(cols)

    ax.set_yticks(range(8))
    ax.set_yticklabels(list("ABCDEFGH"))

    ax.set_xlabel("Column")
    ax.set_ylabel("Row")
    ax.set_title(f"Pipetting heatmap – {excel_path.name}")

    cbar = plt.colorbar(im, ax=ax)
    cbar.set_label("z-score")

    plt.tight_layout()

    out_path = excel_path.with_suffix(".heatmap.png")
    plt.savefig(out_path, dpi=300)
    print(f"Saved heatmap: {out_path}")

    plt.show()

    return z

def analyse_file(filename):
    """
    Load ΔA from the specified Excel file (inside your S5 folder),
    compute z-scores, and plot heatmap.
    """
    excel_path = DATA_DIR / filename  # automatic handling of full path
    if not excel_path.exists():
        raise FileNotFoundError(f"File not found: {excel_path}")

    print(f"\nLoading file: {excel_path}")

    deltaA = load_plate_deltaA(excel_path)
    z = plot_heatmap_z(deltaA, excel_path)

    # Print summary
    mean = np.nanmean(deltaA.values)
    std = np.nanstd(deltaA.values)
    print(f"\nSummary for {filename}")
    print(f"ΔA mean: {mean:.6f}")
    print(f"ΔA SD: {std:.6f}")
    print(f"ΔA range: {np.nanmin(deltaA.values):.6f} to {np.nanmax(deltaA.values):.6f}")
    print(f"Max |z|: {np.nanmax(np.abs(z.values)):.2f}")

    return deltaA, z


if __name__ == "__main__":
    # CHANGE ONLY THE FILENAME HERE:
    analyse_file("pb1a.xlsx")
